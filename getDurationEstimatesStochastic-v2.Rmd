---
title: "Duration Calculations"
author: "Laura F White"
date: "2024-2-7"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
source("utils.R")
library(readxl)
library(ggplot2)
library(reshape)
library(reshape2)
library(RColorBrewer)
library(ggpubr)
library(gridExtra)
library(grid)
library(scales)
library(dplyr)
library(data.table)
library(xlsx)
library(kableExtra)
library(tidyr)
library(tidyverse)
library(broom)
```

```{r,include=F}
# read in data

# prevalence survey estimates, with years and CIs
dat.prev <- read_excel("Data/PrevalenceSurveyData.xlsx",sheet="Sheet1")

# data on treatments 
dat.cure <- read_excel("Data/AnnualTreatments.xlsx",sheet="Sheet1")

# number of simulations to run
M <- 1000

# untreated TB durations tested
unDxTBdur <- seq(3,7)

# read in results from runABCsims.R
load("Results/durEstsABC.RData")
load("Results/simPrevalences-1.RData")
load("Results/simPrevalences-2.RData")
load("Results/allSimResultsABC.RData")

# get incidence estimates for untreated duration assumed to be 5 years
incidence.viet <- lapply(sim.dat.viet,getIncidenceEsts)
incidence.camb <- lapply(sim.dat.camb,getIncidenceEsts)
incidence.china <- lapply(sim.dat.china,getIncidenceEsts)
incidence.indo <- lapply(sim.dat.indo,getIncidenceEsts)
incidence.phil <- lapply(sim.dat.phil,getIncidenceEsts)
incidence.mya <- lapply(sim.dat.mya,getIncidenceEsts)

```

## Methods

### Estimation of the duration of disease
We leverage countries with two prevalence surveys to determine duration and incidence of TB each year between the two prevalence surveys. To do this, we use data on cures and deaths from TB for each country modeled here. We assume that the ratio of prevalence to incidence is not changing over the studied time period (which implies that disease duration is also not changing). As a first, most simple approach to this problem, we determine what the ratio of prevalence to incidence must be to get us to the value of the second prevalence survey. We calculate prevalence in year $t$, $P_t$ as a function of the prior year's prevalence, number treated, number who died and the incidence in the prior year, as follows: $P_t=P_{t-1}-C_{t-1}-D_{t-1}+I_{t-1}$, where $C_t$ are the number of treated (or cured) cases of TB in year $t$ and $D_t$ are the number of deaths or self cures from TB in year $t$. We assume that the number who die or self cure have an average duration of 5 years (though we run a sensitivity analysis for this) and estimate the size of this population to be $D_t=(1/\delta_u)*(P_t-C_t)$, where $\delta_u$ is the duration of untreated disease. 

We observe prevalence at two time points and have annual treatment and mortality data.

We provide more detail on the estimates of prevalence for each country below. We couple prevalence per 100,000 individuals with the population level estimates when the prevalence surveys were conducted to get the total number of prevalent TB cases, which we use in our calculation. 

We loop through a range of duration estimates from 1 to 6 years by 0.01 increments (meaning we consider 501 duration values) and select the durations that are close to the second prevalence survey estimate, assuming that the second prevalence in normally distributed.

To incorporate the uncertainty in the prevalence survey estimates, we use the confidence intervals for each prevalence survey estimate and assume normality to get a standard deviation. We then generate a potential first prevalence survey values from this normal distribution. We estimate annual prevalence until the year of the second prevalence survey using each value in the range of duration estimates, providing 501 vectors of estimated annual prevalence. We use the 501 second prevalence estimates to determine if we will accept or reject the duration value associated with it. To do this, we use the normal distribution to determine if the second prevalence estimate has 0.15 probability of being the same as the observed second prevalence value and accept those that do. This is an Approximate Bayesian approach to estimation and we can change the 0.15 probability, if desired, but more values are rejected. We run the simulation until we accept `r M` duration estimates and we store the simulated first prevalence survey values that were used to get those duration estimates. We then use these `r M` duration values to get the estimated duration and the empirical 95% confidence intervals. 

We perform a sensitivity analysis for the assumed duration of untreated duration of TB disease, $\delta_u$. Our primary simulation assumes that this is 5 years. But we also run the simulations for values ranging from 3 to 7 years.

## Results
### Duration estimates

First we provide the duration estimates for each country assuming a five year duration of untreated disease.

```{r, echo=FALSE}
# create a data frame with all the results in it
durEsts <- bind_rows(dur.ests.camb,dur.ests.china,dur.ests.indo,dur.ests.mya,dur.ests.phil,dur.ests.viet)
Country <- data.frame(rep(c("Cambodia","China","Indonesia","Myanmar","Philippines","Vietnam"),each=length(unDxTBdur)))
names(Country) <- "Country"
durEsts <- bind_cols(Country,durEsts)

# output a table with duration estimates when untreated TB duration is 5 years
durEsts %>% filter(durEsts$`Assumed duration of untreated disease`==5) %>%
  kbl() %>%
  kable_styling()

```


We also consider all values of untreated disease that range between 3 and 7 years. The following figure shows these results.


```{r, echo=FALSE}
figure1 <- ggplot(durEsts, aes(x=Country, y=`Duration of treated disease`)) + 
    geom_pointrange(aes(ymin=LCL,ymax=UCL,color=as.factor(`Assumed duration of untreated disease`)),
                    position=position_dodge(0.5))+
    theme_bw() +
  theme(legend.position = "bottom")+
  guides(color=guide_legend(title="Duration of untreated disease (years)"))

figure1

ggsave("plots/duration-ests-by-country.png")

```

We also show the estimated incidence at the time of the final prevalence survey for each country.

```{r, echo=FALSE}
# first get estimates 
inc.ests.viet <- inc.ests.indo <- inc.ests.camb <- inc.ests.china <- inc.ests.phil <- inc.ests.mya <- matrix(0,nr=5,nc=3)
for(i in 1:5){
inc.ests.viet[i,] <- unlist(incidence.viet[[i]])[c(1:3)*length(unlist(incidence.viet[[i]]))/3]
inc.ests.indo[i,] <- unlist(incidence.indo[[i]])[c(1:3)*length(unlist(incidence.indo[[i]]))/3]
inc.ests.camb[i,] <- unlist(incidence.camb[[i]])[c(1:3)*length(unlist(incidence.camb[[i]]))/3]
inc.ests.china[i,] <- unlist(incidence.china[[i]])[c(1:3)*length(unlist(incidence.china[[i]]))/3]
inc.ests.phil[i,] <- unlist(incidence.phil[[i]])[c(1:3)*length(unlist(incidence.phil[[i]]))/3]
inc.ests.mya[i,] <- unlist(incidence.mya[[i]])[c(1:3)*length(unlist(incidence.mya[[i]]))/3]
}

# create a data frame with all the results in it
incEsts <- data.frame(rbind(inc.ests.camb,inc.ests.china,inc.ests.indo,inc.ests.mya,inc.ests.phil,inc.ests.viet))
names(incEsts) <- c("Incidence per 100k","LCL","UCL")
Country.names <- data.frame(rep(c("Cambodia","China","Indonesia","Myanmar","Philippines","Vietnam"),each=5))
names(Country.names) <- "Country"
incEsts <- bind_cols(Country.names,incEsts)
incEsts$`Assumed duration of untreated disease` <- rep(c(3:7),6)

# output a table with duration estimates when untreated TB duration is 5 years
incEsts %>% filter(incEsts$`Assumed duration of untreated disease`==5) %>%
  kbl() %>%
  kable_styling()

# Now plot this.
figure1.inc <- ggplot(incEsts, aes(x=Country, y=`Incidence per 100k`)) + 
    geom_pointrange(aes(ymin=LCL,ymax=UCL,color=as.factor(`Assumed duration of untreated disease`)),
                    position=position_dodge(0.5)) +
  theme_bw() +
  theme(legend.position = "bottom")+
  guides(color=guide_legend(title="Incidence in last survey year per 100k")) 

figure1.inc

ggsave("plots/incidence-ests-by-country.png")

```



### Estimated annual prevalence 

We can also show the annual estimated prevalence for the duration estimate by country.This shows the estimated annual prevalences using the first prevalence survey value for varying values of untreated TB duration.

```{r, echo=FALSE}
# get estimated prevalences for each duration estimate by country
country.tmp <- "Vietnam"
y1.v <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.v <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.v <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.v <- read.csv("Data/vietnam-pop.csv")
pop1.v <- pop.v$Total.Population[pop.v$label==y1.v]
prev1.v.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.v/100000)

country.tmp <- "Indonesia"
y1.i <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.i <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.i <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.i <- read.csv("Data/indo-pop.csv")
pop1.i <- pop.i$Total.Population[pop.i$label==y1.i]
prev1.i.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.i/100000)

country.tmp <- "China"
y1.c <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.c <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.c <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.c <- read.csv("Data/china-pop.csv")
pop1.c <- pop.c$Total.Population[pop.c$label==y1.c]
prev1.c.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.c/100000)

country.tmp <- "Cambodia"
y1.ca <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.ca <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.ca <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.ca <- read.csv("Data/camb-pop.csv")
pop1.ca <- pop.ca$Total.Population[pop.ca$label==y1.ca]
prev1.ca.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.ca/100000)

country.tmp <- "Philippines"
y1.p <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.p <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.p <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.p <- read.csv("Data/phil-pop.csv")
pop1.p <- pop.p$Total.Population[pop.p$label==y1.p]
prev1.p.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.p/100000)

country.tmp <- "Myanmar"
y1.m <- dat.prev$`First prevalence survey year`[dat.prev$Country==country.tmp]
y2.m <- dat.prev$`Second prevalence survey year`[dat.prev$Country==country.tmp]
cures.m <- dat.cure$cured[dat.cure$Country==country.tmp]
pop.m <- read.csv("Data/myanmar-pop.csv")
pop1.m <- pop.m$Total.Population[pop.m$label==y1.m]
prev1.m.n <- (dat.prev$`1st Prevalence`[dat.prev$Country==country.tmp]/1000)*(pop1.m/100000)

viet.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.v-y1.v+1)
indo.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.i-y1.i+1)
china.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.c-y1.c+1)
camb.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.ca-y1.ca+1)
phil.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.p-y1.p+1)
mya.prev.mean <- matrix(0,nc=length(c(3:7)),nr=y2.m-y1.m+1)
for(i in 1:5){
  viet.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.viet$`Duration of treated disease`[i],prev1=prev1.v.n,
                              cures=cures.v,years=c(y1.v:y2.v),unDxTBdur=i+2)

  indo.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.indo$`Duration of treated disease`[i],prev1=prev1.i.n,
                              cures=cures.i,years=c(y1.i:y2.i),unDxTBdur=i+2)
  
  china.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.china$`Duration of treated disease`[i],prev1=prev1.c.n,
                              cures=cures.c,years=c(y1.c:y2.c),unDxTBdur=i+2)

  camb.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.camb$`Duration of treated disease`[i],prev1=prev1.ca.n,
                              cures=cures.ca,years=c(y1.ca:y2.ca),unDxTBdur=i+2)

  phil.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.phil$`Duration of treated disease`[i],prev1=prev1.p.n,
                              cures=cures.p,years=c(y1.p:y2.p),unDxTBdur=i+2)

  mya.prev.mean[,i] <- calcAnnPrev(duration=dur.ests.mya$`Duration of treated disease`[i],prev1=prev1.m.n,
                              cures=cures.m,years=c(y1.m:y2.m),unDxTBdur=i+2)
}

prev.dat.v <- getPrevLong(viet.prev.mean,y1.v,y2.v,pop.v,country.name="Vietnam")
prev.dat.i <- getPrevLong(indo.prev.mean,y1.i,y2.i,pop.i,country.name="Indonesia")
prev.dat.c <- getPrevLong(china.prev.mean,y1.c,y2.c,pop.c,country.name="China")
prev.dat.ca <- getPrevLong(camb.prev.mean,y1.ca,y2.ca,pop.ca,country.name="Cambodia")
prev.dat.p <- getPrevLong(phil.prev.mean,y1.p,y2.p,pop.p,country.name="Philippines")
prev.dat.m <- getPrevLong(mya.prev.mean,y1.m,y2.m,pop.m,country.name="Myanmar")

all.prev.data <- bind_rows(prev.dat.c,prev.dat.ca,prev.dat.i,prev.dat.m,prev.dat.p,prev.dat.v)
all.prev.data$Year <- as.numeric(all.prev.data$Year)
```


```{r, echo=FALSE}
figure2  <- ggplot(all.prev.data, aes(Year, Prev100k, color = `Untreated duration`)) +
  geom_point() +
  geom_line() +
  labs(y="Prevalence per 100k",color="Disease duration\namong persons \nwith untreated disease") +
  theme_bw() +
  theme(legend.position="bottom") +
  facet_wrap(~Country,scales="free_y") +
  scale_x_continuous(n.breaks=5)

figure2

ggsave("plots/prev-ests-by-country-duration.png")

```


We can also show the uncertainty in prevalence estimates. Following is a plot of the estimated annual prevalence incorporating for uncertainty in the first prevalence value and the uncertainty in the duration estimate.

```{r, echo=FALSE}
# set up data frames with all majore summary results from the model
prev.v <- getPrevCIs(prev.ests.2.v,prev.dat.v,cures.v,y1=y1.v,y2=y2.v,pop.dat=pop.v,dur.ests=dur.ests.viet,unDxTBdur=5)
prev.i <- getPrevCIs(prev.ests.2.i,prev.dat.i,cures.i,y1=y1.i,y2=y2.i,pop.dat=pop.i,dur.ests=dur.ests.indo,unDxTBdur=5)
prev.p <- getPrevCIs(prev.ests.2.p,prev.dat.p,cures.p,y1=y1.p,y2=y2.p,pop.dat=pop.p,dur.ests=dur.ests.phil,unDxTBdur=5)
prev.c <- getPrevCIs(prev.ests.2.c,prev.dat.c,cures.c,y1=y1.c,y2=y2.c,pop.dat=pop.c,dur.ests=dur.ests.china,unDxTBdur=5)
prev.ca <- getPrevCIs(prev.ests.2.ca,prev.dat.ca,cures.ca,y1=y1.ca,y2=y2.ca,pop.dat=pop.ca,dur.ests=dur.ests.camb,unDxTBdur=5)
prev.m <- getPrevCIs(prev.ests.2.m,prev.dat.m,cures.m,y1=y1.m,y2=y2.m,pop.dat=pop.m,dur.ests=dur.ests.mya,unDxTBdur=5)

# generate a plot for each country with prevalence over time and proportion of prevalent disease treated

# Vietnam #
###########
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.v$UCL.100k)
prev.v$trt.rescaled <- plot.max*(prev.v$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.v <- 
  ggplot(prev.v,aes(as.factor(Year),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  xlab("Year") +
  ylab("Prevalence per 100k") +
  ggtitle("Vietnam") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated")) +
    scale_x_discrete(breaks = levels(as.factor(prev.v$Year))[c(T, rep(F, 2))])

# Indonesia #
#############
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.i$UCL.100k)
prev.i$trt.rescaled <- plot.max*(prev.i$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.i <- ggplot(prev.i,aes(as.factor(`Year`),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  ylab("Prevalence per 100k") +
  xlab("Year") +
  ggtitle("Indonesia") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated"))  +
    scale_x_discrete(breaks = levels(as.factor(prev.i$Year))[c(T, rep(F, 2))])

# Philippines #
###############
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.p$UCL.100k)
prev.p$trt.rescaled <- plot.max*(prev.p$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.p <- ggplot(prev.p,aes(as.factor(`Year`),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  ylab("Prevalence per 100k") +
  xlab("Year") +
  ggtitle("Philippines") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated")) +
    scale_x_discrete(breaks = levels(as.factor(prev.p$Year))[c(T, rep(F, 2))])

# China #
###############
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.c$UCL.100k)
prev.c$trt.rescaled <- plot.max*(prev.c$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.c <- ggplot(prev.c,aes(as.factor(`Year`),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  xlab("Year") +
  ylab("Prevalence per 100k") +
  ggtitle("China") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated")) +
    scale_x_discrete(breaks = levels(as.factor(prev.c$Year))[c(T, rep(F, 2))])

# Cambodia #
###############
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.ca$UCL.100k)
prev.ca$trt.rescaled <- plot.max*(prev.ca$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.ca <- ggplot(prev.ca,aes(as.factor(`Year`),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  xlab("Year") +
  ylab("Prevalence per 100k") +
  ggtitle("Cambodia") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated")) +
    scale_x_discrete(breaks = levels(as.factor(prev.ca$Year))[c(T, rep(F, 2))])

# Myanmar #
###############
##### plot results with CI bands for duration=5 and overlay treatment rates #####

##  get treatment rates on the same scale as incidence
plot.max <- max(prev.m$UCL.100k)
prev.m$trt.rescaled <- plot.max*(prev.m$`Proportion treated`)

# shading for confidence bounds-I like this better
plot.m <- ggplot(prev.ca,aes(as.factor(`Year`),Prev100k,group=1)) + 
  geom_point() + 
  geom_line() +
  geom_ribbon(aes(ymin=LCL.100k,ymax=UCL.100k),alpha=0.3,fill="blue") +
  theme_bw() +
  xlab("Year") +
  ylab("Prevalence per 100k") +
  ggtitle("Myanmar") +
  geom_point(aes(x=as.factor(`Year`),y=trt.rescaled),shape=24) +
  scale_y_continuous(sec.axis=sec_axis(~. *(1/plot.max),name="Proportion of prevalent cases treated")) +
    scale_x_discrete(breaks = levels(as.factor(prev.m$Year))[c(T, rep(F, 2))])

all.figs <- ggarrange(plot.c + rremove("ylab") + rremove("xlab"),plot.m + rremove("ylab") + rremove("xlab"),
                      plot.ca + rremove("ylab") + rremove("xlab"),plot.v + rremove("ylab") + rremove("xlab"),
                      plot.p + rremove("ylab") + rremove("xlab"),plot.i + rremove("ylab") + rremove("xlab"),
          ncol=2,nrow=3,align = "hv")

annotate_figure(all.figs, left = textGrob("Prevalence per 100k", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Year", gp = gpar(cex = 1.3)),
                    right = textGrob("Proportion of prevalent cases treated", rot = 90, vjust = 0.5, gp = gpar(cex = 1.3)))

ggsave("plots/prev-trtd-by-country.png")

```


### Cures related to change in prevalence
We first look at the relationship between the proportion of prevalent cases treated and the annual change in prevalence per 100k.

```{r, echo=FALSE}
### plot the change in prevalence versus proprtion prevalent cases treated for all countries
# First create a dataframe with all the data together
all.model.dat <- bind_rows(prev.c,prev.ca,prev.i,prev.p,prev.m,prev.v)

# fit model and store R^2
fit1 <- lm(PrevDelta~`Proportion treated`,data=all.model.dat)
r.2 <- round(summary(fit1)$r.squared,2)
fig1.r2 <- ~~italic(r)^2~"="~r.2

# all the data together
ggplot(all.model.dat,aes(x=`Proportion treated`,y=PrevDelta)) +
  geom_point() +
  ylab("Annual change in prevalence per 100k") +
  xlab("Proportion of prevalence cases treated") +
  ggtitle("Overall relationship between the \nproportion treated and change in Prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth") +
  geom_text(x = 0.6, y = 50, label = paste("~R^{2}==",r.2), parse = TRUE)

ggsave("plots/prev-prop-trtd.png")


# fits stratified by countries
ggplot(all.model.dat,aes(x=`Proportion treated`,y=PrevDelta,col=Country)) +
  geom_point() +
  ylab("Annual change in prevalence per 100k") +
  xlab("Proportion of prevalence cases treated") +
  ggtitle("Country level relationship between the \nproportion treated and change in Prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth")

# get slopes for these fitted lines
fit.all <- lm(PrevDelta~`Proportion treated`,data=all.model.dat)

fit.country <- all.model.dat %>%
  group_by(Country) %>%
  group_modify(~tidy(lm(PrevDelta~`Proportion treated`,data=.)))

# create table of these results
all.res.tidy <- data.frame(matrix(c("Overall",fit.all$coefficients[2],1-pf(summary(fit.all)$fstatistic[1],summary(fit.all)$fstatistic[2],summary(fit.all)$fstatistic[3])),nr=1))
names(all.res.tidy) <- c("Country","estimate","p.value")
dat.lm.results.deltaprev <- rbind(all.res.tidy,data.frame(fit.country[2*c(1:6),c(1,3,6)]))

# change to make th estimate per a 10% increase in treatment
dat.lm.results.deltaprev$estimate <- round(as.numeric(dat.lm.results.deltaprev$estimate),2)/10
dat.lm.results.deltaprev$p.value <- round(as.numeric(dat.lm.results.deltaprev$p.value),4)

names(dat.lm.results.deltaprev)[2:3] <- c("Estimate per 0.1 increase","p-value")

dat.lm.results.deltaprev %>% 
  kbl(caption="Linear regression fit to relationship between the proportion treated and the annual change in estimated prevalence overall and by country. Estimates shown are per 10% increase in the percent of cases treated.") %>%
  kable_styling()


```

### Cures related to Incidence
```{r, echo=FALSE}
### plot the incidence versus proportion prevalent cases treated for all countries
# all the data together
ggplot(all.model.dat,aes(x=`Proportion treated`,y=Incidence100k)) +
  geom_point() +
  ylab("Incidence per 100k") +
  xlab("Proportion of prevalence cases treated") +
  ggtitle("Overall relationship between the \nproportion treated and Incidence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth")


# fits stratified by countries
ggplot(all.model.dat,aes(x=`Proportion treated`,y=Incidence100k,col=Country)) +
  geom_point() +
  ylab("Incidence per 100k") +
  xlab("Proportion of prevalence cases treated") +
  ggtitle("Country level relationship between the \nproportion treated and Incidence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth")

# get slopes for these fitted lines
fit.all.i <- lm(Incidence100k~`Proportion treated`,data=all.model.dat)

fit.country.i <- all.model.dat %>%
  group_by(Country) %>%
  group_modify(~tidy(lm(Incidence100k~`Proportion treated`,data=.)))

# create table of these results
all.res.tidy.i <- data.frame(matrix(c("Overall",fit.all.i$coefficients[2],1-pf(summary(fit.all.i)$fstatistic[1],summary(fit.all.i)$fstatistic[2],summary(fit.all.i)$fstatistic[3])),nr=1))
names(all.res.tidy.i) <- c("Country","estimate","p.value")
dat.lm.results.deltaprev.i <- rbind(all.res.tidy.i,data.frame(fit.country.i[2*c(1:6),c(1,3,6)]))

dat.lm.results.deltaprev.i$estimate <- round(as.numeric(dat.lm.results.deltaprev.i$estimate),2)/10
dat.lm.results.deltaprev.i$p.value <- round(as.numeric(dat.lm.results.deltaprev.i$p.value),4)

names(dat.lm.results.deltaprev.i)[2:3] <- c("Estimate per 0.1 increase","p-value")

dat.lm.results.deltaprev.i %>% 
  kbl(caption="Linear regression fit to relationship between the proportion treated and the annual estimated incidence overall and by country. Estimates shown are per 10% increase in the percent of cases.") %>%   kable_styling()

```

### Cures per incidence related to Change in prevalance
```{r, echo=FALSE}
### plot the incidence versus proportion prevalent cases treated for all countries
# create a variable which is percent change in prevalence
all.model.dat$PrevDeltaPerc <- round((all.model.dat$PrevDelta/all.model.dat$Prev100k)*100,2)

fit.inc <- lm(PrevDeltaPerc~PropIncTreated,data=all.model.dat)
r2.inc <- round(summary(fit.inc)$r.squared,2)
ggplot(all.model.dat,aes(x=PropIncTreated,y=PrevDeltaPerc)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of incident cases treated") +
  ggtitle("Overall relationship between the \nproportion incident cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth") +
    geom_text(x = 1.5, y = 5, label = paste("~R^{2}==",r2.inc), parse = TRUE)
ggsave("plots/prev-prop-inc-trd.png")

ggplot(all.model.dat,aes(x=PropIncTreated,y=PrevDeltaPerc)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of incident cases treated") +
  ggtitle("Overall relationship between the \nproportion incident cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='loess',
              formula=y~x,
              geom="smooth")


# fits stratified by countries
ggplot(all.model.dat,aes(x=PropIncTreated,y=PrevDeltaPerc,col=Country)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of incident cases treated") +
  ggtitle("Country level relationship between the \nproportion incident cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth")

# get slopes for these fitted lines
fit.all.2 <- lm(PrevDeltaPerc~PropIncTreated,data=all.model.dat)

fit.country.2 <- all.model.dat %>%
  group_by(Country) %>%
  group_modify(~tidy(lm(PrevDeltaPerc~PropIncTreated,data=.)))

# create table of these results
all.res.tidy.2 <- data.frame(matrix(c("Overall",fit.all.2$coefficients[2],1-pf(summary(fit.all.2)$fstatistic[1],summary(fit.all.2)$fstatistic[2],summary(fit.all.2)$fstatistic[3])),nr=1))
names(all.res.tidy.2) <- c("Country","estimate","p.value")
dat.lm.results.deltaprev.2 <- rbind(all.res.tidy.2,data.frame(fit.country.2[2*c(1:6),c(1,3,6)]))

dat.lm.results.deltaprev.2$estimate <- round(as.numeric(dat.lm.results.deltaprev.2$estimate),2)/10
dat.lm.results.deltaprev.2$p.value <- round(as.numeric(dat.lm.results.deltaprev.2$p.value),4)

names(dat.lm.results.deltaprev.2)[2:3] <- c("Estimate per 0.1 increase","p-value")

dat.lm.results.deltaprev.2 %>% 
  kbl(caption="Linear regression fit to relationship between the proportion incident individuals treated and the annual percent change in prevalence overall and by country. Estimates shown are per 10% increase in the proportion of treated cases.") %>%   kable_styling()

```


### Cures per prevalence related to Change in prevalance
```{r, echo=FALSE}
### plot the incidence versus proportion prevalent cases treated for all countries
# create a variable which is percent change in prevalence

fit.prev <- lm(PrevDeltaPerc~`Proportion treated`,data=all.model.dat)
r.2.prev <- round(summary(fit.prev)$r.squared,2)
ggplot(all.model.dat,aes(x=`Proportion treated`,y=PrevDeltaPerc)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of prevalent cases treated") +
  ggtitle("Overall relationship between the \nproportion prevalent cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth") +
   geom_text(x = 0.6, y = 5, label = paste("~R^{2}==",r.2.prev), parse = TRUE)
ggsave("plots/prev-prop-trtd.png") 

ggplot(all.model.dat,aes(x=`Proportion treated`,y=PrevDeltaPerc)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of prevalent cases treated") +
  ggtitle("Overall relationship between the \nproportion prevalent cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='loess',
              formula=y~x,
              geom="smooth")

# fits stratified by countries
ggplot(all.model.dat,aes(x=`Proportion treated`,y=PrevDeltaPerc,col=Country)) +
  geom_point() +
  ylab("Annual percent change in prevalence") +
  xlab("Proportion of prevalent cases treated") +
  ggtitle("Country level relationship between the \nproportion prevalent cases treated and change in prevalence") +
  theme_bw() +
  stat_smooth(method='lm',
              formula=y~x,
              geom="smooth")

# get slopes for these fitted lines
fit.all.3 <- lm(PrevDeltaPerc~`Proportion treated`,data=all.model.dat)

fit.country.3 <- all.model.dat %>%
  group_by(Country) %>%
  group_modify(~tidy(lm(PrevDeltaPerc~`Proportion treated`,data=.)))

# create table of these results
all.res.tidy.3 <- data.frame(matrix(c("Overall",fit.all.3$coefficients[2],1-pf(summary(fit.all.3)$fstatistic[1],summary(fit.all.3)$fstatistic[2],summary(fit.all.3)$fstatistic[3])),nr=1))
names(all.res.tidy.3) <- c("Country","estimate","p.value")
dat.lm.results.deltaprev.3 <- rbind(all.res.tidy.3,data.frame(fit.country.3[2*c(1:6),c(1,3,6)]))

dat.lm.results.deltaprev.3$estimate <- round(as.numeric(dat.lm.results.deltaprev.3$estimate),2)/10
dat.lm.results.deltaprev.3$p.value <- round(as.numeric(dat.lm.results.deltaprev.3$p.value),4)

names(dat.lm.results.deltaprev.3)[2:3] <- c("Estimate per 0.1 increase","p-value")

dat.lm.results.deltaprev.3 %>% 
  kbl(caption="Linear regression fit to relationship between the proportion prevalent individuals treated and the annual percent change in prevalence overall and by country. Estimates shown are per 10% increase in the proportion of treated cases.") %>%   kable_styling()

# what is associated with a 10% reduction in prevalence?
(-10-fit.all.3$coefficients[1])/fit.all.3$coefficients[2]
                                                       
# what is associated with a 20% reduction in prevalence?
(-20-fit.all.3$coefficients[1])/fit.all.3$coefficients[2]
```


## All model results
 
Finally we show all the model results below.

```{r, echo=F}
row.names(all.model.dat) <- NULL
all.model.dat %>% 
  kbl() %>%   kable_styling()

```